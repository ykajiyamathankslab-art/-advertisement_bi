<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f4f6f9; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
    .card-header { font-weight: bold; color: white; }
    .header-rakuten { background-color: #BF0000; } 
    .header-choice { background-color: #00B900; } 
    .header-total { background-color: #2c3e50; } 
    .header-history { background-color: #6f42c1; }
    .metric-value { font-size: 24px; font-weight: bold; color: #333; }
    .metric-label { font-size: 12px; color: #666; }
    .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 20%; }
    .table-sm th, .table-sm td { font-size: 0.85rem; vertical-align: middle; }
    .high-impact { background-color: #e6f4ea; color: #1e7e34; font-weight: bold; }
    .total-row { background-color: #343a40 !important; color: white !important; font-weight: bold; }
    .detail-label { font-weight: bold; color: #555; font-size: 0.9rem; }
    .detail-val { font-size: 1.1rem; }
    .scroll-table { max-height: 300px; overflow-y: auto; }
    .rank-badge { background-color: #ffc107; color: #000; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
    .status-badge-on { background-color: #28a745; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; }
    .status-badge-off { background-color: #e9ecef; color: #6c757d; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; border: 1px solid #ced4da; }
    
    /* æ¯”è¼ƒè¡¨ç¤ºç”¨ */
    .compare-up { color: #28a745; font-weight: bold; }
    .compare-down { color: #dc3545; font-weight: bold; }
    .compare-badge { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    .compare-badge.up { background-color: #d4edda; color: #155724; }
    .compare-badge.down { background-color: #f8d7da; color: #721c24; }
    
    /* ä¿å­˜ãƒ‘ãƒãƒ« */
    .save-panel { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .save-panel .form-control, .save-panel .form-select { background-color: rgba(255,255,255,0.9); }
    
    /* å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« */
    .history-table { font-size: 0.85rem; }
    .history-table th { background-color: #6f42c1; color: white; position: sticky; top: 0; }
    
    @media print { .no-print { display: none !important; } .scroll-table { max-height: none; } }
  </style>
</head>
<body>

<div class="container mt-4">
  <div class="row mb-4 no-print">
    <div class="col-12 text-center">
      <h2>è‡ªæ²»ä½“åºƒå‘Šé‹ç”¨ çµ±åˆBIãƒ„ãƒ¼ãƒ« v2.0</h2>
      <p class="text-muted">å±¥æ­´ä¿å­˜ãƒ»å‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æå¯¾å¿œ</p>
    </div>
  </div>

  <div class="card no-print" id="uploadArea">
    <div class="card-body">
      <div class="mb-3">
        <label for="excelFile" class="form-label">ç®¡ç†ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input class="form-control" type="file" id="excelFile" accept=".xlsx, .xls">
      </div>
      <button onclick="uploadFile()" class="btn btn-primary w-100">åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3">ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆãƒ»è§£æä¸­...</h4>
  </div>

  <div id="dashboard" style="display:none;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 id="reportTitle">åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3>
      <div class="btn-group no-print">
        <button onclick="downloadPDF()" class="btn btn-dark">ğŸ“Š PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button onclick="downloadExcel()" class="btn btn-success">ğŸ“— Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
    </div>

    <!-- â˜…â˜…â˜… å±¥æ­´ä¿å­˜ãƒ‘ãƒãƒ« â˜…â˜…â˜… -->
    <div class="card no-print" id="savePanel">
      <div class="card-header save-panel">ğŸ’¾ å±¥æ­´ã«ä¿å­˜ï¼ˆå‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ç”¨ï¼‰</div>
      <div class="card-body save-panel">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label class="form-label text-white">å¯¾è±¡å¹´æœˆ</label>
            <input type="month" id="saveYearMonth" class="form-control">
          </div>
          <div class="col-md-4">
            <button onclick="saveToHistory()" class="btn btn-warning w-100" id="saveBtn">
              <strong>ğŸ“¥ ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</strong>
            </button>
          </div>
          <div class="col-md-4">
            <small class="text-white-50">â€» åŒã˜å¹´æœˆã¯ä¸Šæ›¸ãä¿å­˜ã•ã‚Œã¾ã™ï¼ˆæš«å®šâ†’ç¢ºå®šã®æ›´æ–°OKï¼‰</small>
          </div>
        </div>
        <div id="saveMessage" class="mt-2"></div>
      </div>
    </div>

    <!-- â˜…â˜…â˜… å‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ãƒ‘ãƒãƒ« â˜…â˜…â˜… -->
    <div class="card" id="comparisonPanel" style="display:none;">
      <div class="card-header header-history">ğŸ“ˆ å‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ã‚µãƒãƒªãƒ¼</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered text-center mb-0">
            <thead class="table-dark">
              <tr>
                <th rowspan="2">æŒ‡æ¨™</th>
                <th colspan="3">æ¥½å¤©</th>
                <th colspan="3">ãƒãƒ§ã‚¤ã‚¹</th>
                <th colspan="3">åˆè¨ˆ</th>
              </tr>
              <tr>
                <th>å½“æœˆ</th><th>å‰æœˆæ¯”</th><th>å‰å¹´æ¯”</th>
                <th>å½“æœˆ</th><th>å‰æœˆæ¯”</th><th>å‰å¹´æ¯”</th>
                <th>å½“æœˆ</th><th>å‰æœˆæ¯”</th><th>å‰å¹´æ¯”</th>
              </tr>
            </thead>
            <tbody id="comparisonBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â˜…â˜…â˜… 12ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ• â˜…â˜…â˜… -->
    <div class="card" id="trendPanel" style="display:none;">
      <div class="card-header header-history">ğŸ“Š 12ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6"><canvas id="trendSalesChart"></canvas></div>
          <div class="col-md-6"><canvas id="trendRoasChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- â˜…â˜…â˜… å±¥æ­´ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« â˜…â˜…â˜… -->
    <div class="card" id="historyPanel" style="display:none;">
      <div class="card-header header-history d-flex justify-content-between align-items-center">
        <span>ğŸ“‹ ä¿å­˜æ¸ˆã¿å±¥æ­´ä¸€è¦§</span>
        <button class="btn btn-sm btn-light" onclick="toggleHistoryTable()">è¡¨ç¤º/éè¡¨ç¤º</button>
      </div>
      <div class="card-body scroll-table" id="historyTableWrapper" style="display:none;">
        <table class="table table-sm table-striped history-table">
          <thead><tr><th>å¹´æœˆ</th><th>æ›´æ–°æ—¥æ™‚</th><th>æ¥½å¤©å£²ä¸Š</th><th>æ¥½å¤©ROAS</th><th>ãƒãƒ§ã‚¤ã‚¹å£²ä¸Š</th><th>ãƒãƒ§ã‚¤ã‚¹ROAS</th><th>åˆè¨ˆå£²ä¸Š</th><th>åˆè¨ˆROAS</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <!-- å…¨ä½“ã‚µãƒãƒªãƒ¼ -->
    <div class="card border-dark mb-4">
      <div class="card-header header-total">ğŸ‘‘ åºƒå‘Šé‹ç”¨ãƒˆãƒ¼ã‚¿ãƒ«ã‚µãƒãƒªãƒ¼ (æ¥½å¤© + ãƒãƒ§ã‚¤ã‚¹)</div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3"><div class="metric-label">åˆè¨ˆå¯„ä»˜é¡</div><div class="metric-value text-primary" id="totalSales">-</div></div>
          <div class="col-md-2"><div class="metric-label">æ¶ˆåŒ–é¡ / äºˆç®—</div><div class="detail-val"><span id="totalCost">-</span> <span class="small text-muted">/ <span id="totalBudget">-</span></span></div></div>
          <div class="col-md-2"><div class="metric-label">å…¨ä½“ROAS</div><div class="metric-value" id="totalRoas">-</div></div>
          <div class="col-md-2"><div class="metric-label">åˆè¨ˆç²å¾—æ•°</div><div class="metric-value" id="totalCv">-</div></div>
          <div class="col-md-3"><div class="metric-label">å…¨ä½“CPA</div><div class="metric-value" id="totalCpa">-</div></div>
        </div>
      </div>
    </div>

    <h4 class="text-danger border-bottom pb-2 mb-3">ğŸ”´ æ¥½å¤©RPPåºƒå‘Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h4>
    
    <div class="card">
      <div class="card-header header-rakuten">ğŸ“‹ ã€æ¥½å¤©ã€‘æœˆæ¬¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´°</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 border-end">
            <h6 class="text-danger border-bottom pb-2">ã‚³ã‚¹ãƒˆãƒ»æµå…¥</h6>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ä½¿ç”¨åºƒå‘Šè²»:</span><span class="detail-val" id="rSumCost">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ã‚¯ãƒªãƒƒã‚¯æ•°:</span><span class="detail-val" id="rSumClicks">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">å¹³å‡CPC:</span><span class="detail-val" id="rSumCpc">-</span></div>
            <div class="d-flex justify-content-between"><span class="detail-label">CTR:</span><span class="detail-val" id="rSumCtr">-</span></div>
          </div>
          <div class="col-md-4 border-end">
            <h6 class="text-primary border-bottom pb-2">æˆæœãƒ»åŠ¹ç‡</h6>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">RPPå£²ä¸Š:</span><span class="detail-val fw-bold" id="rSumSales">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ç²å¾—ä»¶æ•°:</span><span class="detail-val" id="rSumCv">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ROAS:</span><span class="detail-val fw-bold text-danger" id="rSumRoas">-</span></div>
            <div class="d-flex justify-content-between"><span class="detail-label">CVR:</span><span class="detail-val" id="rSumCvr">-</span></div>
          </div>
          <div class="col-md-4">
            <h6 class="text-success border-bottom pb-2">æ–°è¦ãƒ»æ—¢å­˜å†…è¨³</h6>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">æ–°è¦å£²ä¸Š:</span><span class="detail-val" id="rSumNewSales">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">æ–°è¦CV:</span><span class="detail-val" id="rSumNewCv">-</span></div>
            <hr class="my-2">
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">æ—¢å­˜å£²ä¸Š:</span><span class="detail-val" id="rSumExSales">-</span></div>
            <div class="d-flex justify-content-between"><span class="detail-label">æ—¢å­˜CV:</span><span class="detail-val" id="rSumExCv">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header header-rakuten">ğŸ“Š RPPè²¢çŒ®åº¦ãƒ»æ—¥æ¬¡è©³ç´°</div>
      <div class="card-body p-0 scroll-table">
        <table class="table table-sm table-bordered text-center mb-0">
          <thead class="table-light"><tr><th>æ—¥ä»˜</th><th>å…¨ä½“å£²ä¸Š</th><th>RPPå£²ä¸Š</th><th>è²¢çŒ®ç‡</th><th>CV</th><th>ROAS</th></tr></thead>
          <tbody id="rakutenTableBody"></tbody>
          <tfoot id="rakutenTableFoot"></tfoot>
        </table>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-8"><div class="card"><div class="card-header header-rakuten">æ—¥æ¬¡å£²ä¸Š vs ã‚³ã‚¹ãƒˆ</div><div class="card-body"><canvas id="rakutenChart"></canvas></div></div></div>
      <div class="col-md-4"><div class="card"><div class="card-header header-rakuten">ROASæ¨ç§»</div><div class="card-body"><canvas id="rakutenRoasChart"></canvas></div></div></div>
    </div>

    <div class="card mt-3">
      <div class="card-header bg-dark text-white">ğŸ‰ CVç²å¾—å•†å“ & æµå…¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ (ã‚¯ãƒ­ã‚¹ãƒã‚§ãƒƒã‚¯)</div>
      <div class="card-body scroll-table">
        <table class="table table-sm table-striped">
          <thead><tr><th>å•†å“å</th><th>ä»¶æ•°</th><th>é‡‘é¡</th><th>KWãƒ©ãƒ³ã‚¯</th><th>RPPè¨­å®š</th><th>KWè¨­å®š</th></tr></thead>
          <tbody id="rSoldBody"></tbody>
        </table>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-secondary text-white">ğŸ“Œ ç¾åœ¨ã®RPPå‡ºç¨¿ãƒªã‚¹ãƒˆ</div>
          <div class="card-body scroll-table"><table class="table table-sm table-striped"><thead><tr><th>å•†å“å</th><th>ä¾¡æ ¼</th><th>CPC</th></tr></thead><tbody id="rppListBody"></tbody></table></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-secondary text-white">ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®šãƒªã‚¹ãƒˆ</div>
          <div class="card-body scroll-table"><table class="table table-sm table-striped"><thead><tr><th>å¯¾è±¡å•†å“</th><th>KW</th><th>CPC</th></tr></thead><tbody id="kwListBody"></tbody></table></div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-success text-white">ğŸ’ æ¬¡æœˆå¼·åŒ–æ¨å¥¨</div>
          <div class="card-body"><ul id="rAddList" class="list-group list-group-flush"></ul></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header bg-info text-white">ğŸ” æ©Ÿä¼šæå¤±ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</div>
          <div class="card-body scroll-table"><table class="table table-sm"><thead><tr><th>é †ä½</th><th>KW</th><th>ã‚¢ã‚¯ã‚»ã‚¹</th></tr></thead><tbody id="rMissKwBody"></tbody></table></div>
        </div>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-header bg-secondary text-white">ğŸ› ï¸ [æ¥½å¤©] é‹ç”¨ãƒ»ä½œæ¥­å±¥æ­´</div>
      <div class="card-body scroll-table"><table class="table table-sm"><thead><tr><th>æ—¥ä»˜</th><th>ä½œæ¥­</th><th>è©³ç´°</th></tr></thead><tbody id="rHistoryBody"></tbody></table></div>
    </div>

    <!-- â˜…â˜…â˜… æ¥½å¤© vs ãƒãƒ§ã‚¤ã‚¹ æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ â˜…â˜…â˜… -->
    <h4 class="border-bottom pb-2 mb-3 mt-5" style="color: #6f42c1;">ğŸ”´ğŸŸ¢ æ¥½å¤© vs ãƒãƒ§ã‚¤ã‚¹ CVç²å¾—å•†å“ æ¯”è¼ƒ</h4>
    
    <div class="row">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header header-rakuten">ğŸ”´ æ¥½å¤© CVç²å¾—å•†å“ Top10</div>
          <div class="card-body scroll-table p-0">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-light"><tr><th>#</th><th>å•†å“å</th><th>CV</th><th>é‡‘é¡</th></tr></thead>
              <tbody id="compareRakutenBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header header-choice">ğŸŸ¢ ãƒãƒ§ã‚¤ã‚¹ CVç²å¾—å•†å“ Top10</div>
          <div class="card-body scroll-table p-0">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-light"><tr><th>#</th><th>å•†å“å</th><th>CV</th><th>é‡‘é¡</th></tr></thead>
              <tbody id="compareChoiceBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header" style="background-color: #6f42c1; color: white;">ğŸ“Š CVç²å¾—å•†å“ ã‚µãƒãƒªãƒ¼æ¯”è¼ƒ</div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3">
            <div class="metric-label">æ¥½å¤© CVå•†å“æ•°</div>
            <div class="metric-value text-danger" id="compareRakutenCount">-</div>
          </div>
          <div class="col-md-3">
            <div class="metric-label">æ¥½å¤© CVåˆè¨ˆé‡‘é¡</div>
            <div class="metric-value text-danger" id="compareRakutenTotal">-</div>
          </div>
          <div class="col-md-3">
            <div class="metric-label">ãƒãƒ§ã‚¤ã‚¹ CVå•†å“æ•°</div>
            <div class="metric-value text-success" id="compareChoiceCount">-</div>
          </div>
          <div class="col-md-3">
            <div class="metric-label">ãƒãƒ§ã‚¤ã‚¹ CVåˆè¨ˆé‡‘é¡</div>
            <div class="metric-value text-success" id="compareChoiceTotal">-</div>
          </div>
        </div>
      </div>
    </div>


    <h4 class="text-success border-bottom pb-2 mb-3 mt-5">ğŸŸ¢ ãµã‚‹ã•ã¨ãƒãƒ§ã‚¤ã‚¹åºƒå‘Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h4>

    <div class="card">
      <div class="card-header header-choice">ğŸ“‹ ã€ãƒãƒ§ã‚¤ã‚¹ã€‘æœˆæ¬¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´° (æ—¥æ¬¡é›†è¨ˆ)</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 border-end">
            <h6 class="text-danger border-bottom pb-2">ã‚³ã‚¹ãƒˆãƒ»æµå…¥</h6>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ä½¿ç”¨åºƒå‘Šè²»:</span><span class="detail-val" id="cSumCost">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">äºˆç®—:</span><span class="detail-val" id="cSumBudget">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">imp (è¡¨ç¤ºå›æ•°):</span><span class="detail-val" id="cSumImp">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ã‚¯ãƒªãƒƒã‚¯æ•°:</span><span class="detail-val" id="cSumClicks">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">å¹³å‡CPC:</span><span class="detail-val" id="cSumCpc">-</span></div>
            <div class="d-flex justify-content-between"><span class="detail-label">CTR:</span><span class="detail-val" id="cSumCtr">-</span></div>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary border-bottom pb-2">æˆæœãƒ»åŠ¹ç‡</h6>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">å¯„ä»˜çµŒç”±é¡:</span><span class="detail-val fw-bold" id="cSumSales">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">å¯„ä»˜ä»¶æ•° (CV):</span><span class="detail-val" id="cSumCv">-</span></div>
            <div class="d-flex justify-content-between mb-2"><span class="detail-label">ROAS:</span><span class="detail-val fw-bold text-success" id="cSumRoas">-</span></div>
            <div class="d-flex justify-content-between"><span class="detail-label">CVR:</span><span class="detail-val" id="cSumCvr">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-8"><div class="card"><div class="card-header header-choice">æ—¥æ¬¡æ¨ç§»</div><div class="card-body"><canvas id="choiceChart"></canvas></div></div></div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header header-choice">åŠ¹æœã®é«˜ã„å•†å“ Top5</div>
          <div class="card-body p-0"><ul id="cProdList" class="list-group list-group-flush small"></ul></div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header bg-dark text-white">ğŸ‰ [ãƒãƒ§ã‚¤ã‚¹] CVç²å¾—å•†å“ä¸€è¦§</div>
      <div class="card-body scroll-table">
        <table class="table table-sm table-striped">
          <thead><tr><th>å•†å“å</th><th>CVä»¶æ•°</th><th>å¯„ä»˜é¡</th><th>æ¶ˆåŒ–é¡</th><th>ROAS</th></tr></thead>
          <tbody id="cSoldBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header header-choice">ğŸ”‘ è¨­å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ¥æˆæœ</div>
      <div class="card-body scroll-table">
        <table class="table table-sm table-striped">
          <thead><tr><th>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th><th>å¯¾è±¡å•†å“</th><th>å¯„ä»˜é¡</th><th>CV</th><th>æ¶ˆåŒ–é¡</th></tr></thead>
          <tbody id="choiceKeywordBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header bg-secondary text-white">ğŸ› ï¸ [ãƒãƒ§ã‚¤ã‚¹] é‹ç”¨ãƒ»ä½œæ¥­å±¥æ­´</div>
      <div class="card-body scroll-table"><table class="table table-sm"><thead><tr><th>æ—¥ä»˜</th><th>ä½œæ¥­</th><th>è©³ç´°</th></tr></thead><tbody id="cHistoryBody"></tbody></table></div>
    </div>

    <div class="card mt-5 page-break-avoid">
      <div class="card-header bg-secondary text-white">ğŸ“ çµ±åˆé‹ç”¨ãƒ¬ãƒãƒ¼ãƒˆè€ƒå¯Ÿ (è‡ªå‹•ç”Ÿæˆ)</div>
      <div class="card-body">
        <textarea id="observationText" class="form-control" rows="18" readonly style="background-color: #fdfdfd; font-size: 14px; line-height: 1.6;"></textarea>
      </div>
    </div>

  </div>
</div>

<script>
let rakutenChart = null;
let rakutenRoasChart = null;
let choiceChart = null;
let trendSalesChart = null;
let trendRoasChart = null;
let reportData = null;

function uploadFile() {
  const fileInput = document.getElementById('excelFile');
  if (fileInput.files.length === 0) { alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
  document.getElementById('loading').style.display = 'block';
  document.getElementById('uploadArea').style.display = 'none'; 
  document.getElementById('dashboard').style.display = 'none';

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64 = e.target.result.split(',')[1];
    google.script.run
      .withSuccessHandler(renderDashboard)
      .withFailureHandler(err => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('uploadArea').style.display = 'block';
        alert("ã‚¨ãƒ©ãƒ¼: " + err);
      })
      .processExcelReport(base64, file.name);
  };
  reader.readAsDataURL(file);
}

function renderDashboard(data) {
  reportData = data;
  document.getElementById('loading').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('reportTitle').textContent = `${data.meta.municipality} ${data.meta.period} çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ`;
  
  // ä¿å­˜ç”¨å¹´æœˆã‚’ã‚»ãƒƒãƒˆ
  if (data.meta && data.meta.yearMonth) {
    document.getElementById('saveYearMonth').value = data.meta.yearMonth.replace('/', '-');
  }
  
  const fmt = (n) => new Intl.NumberFormat('ja-JP').format(Math.round(n));
  const fmtC = (n) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(Math.round(n));

  // --- 1. å…¨ä½“ã‚µãƒãƒªãƒ¼ ---
  const t = data.totalData;
  document.getElementById('totalSales').textContent = fmtC(t.sales);
  document.getElementById('totalCost').textContent = fmtC(t.cost);
  document.getElementById('totalBudget').textContent = fmtC(t.budget);
  document.getElementById('totalRoas').textContent = t.roas.toFixed(0) + '%';
  document.getElementById('totalCv').textContent = fmt(t.cv) + 'ä»¶';
  document.getElementById('totalCpa').textContent = fmt(t.cpa) + 'å††';

  // --- 2. æ¥½å¤©è©³ç´° ---
  const r = data.rakutenData;
  const rm = r.monthlySummaryDetails;
  
  document.getElementById('rSumCost').textContent = fmtC(rm.cost);
  document.getElementById('rSumClicks').textContent = fmt(rm.clicks) + "å›";
  document.getElementById('rSumCpc').textContent = fmt(rm.cpc) + "å††";
  document.getElementById('rSumCtr').textContent = rm.ctr.toFixed(2) + "%";
  document.getElementById('rSumSales').textContent = fmtC(rm.salesTotal);
  document.getElementById('rSumCv').textContent = fmt(rm.cvTotal) + "ä»¶";
  document.getElementById('rSumRoas').textContent = fmt(rm.roasTotal) + "%";
  document.getElementById('rSumCvr').textContent = rm.cvrTotal.toFixed(2) + "%";
  document.getElementById('rSumNewSales').textContent = fmtC(rm.salesNew);
  document.getElementById('rSumNewCv').textContent = fmt(rm.cvNew) + "ä»¶";
  document.getElementById('rSumExSales').textContent = fmtC(rm.salesExisting);
  document.getElementById('rSumExCv').textContent = fmt(rm.cvExisting) + "ä»¶";

  const rakutenBody = document.getElementById('rakutenTableBody');
  const rakutenFoot = document.getElementById('rakutenTableFoot');
  rakutenBody.innerHTML = '';
  r.contributionAnalysis.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.date}</td><td>${fmt(row.storeSales)}</td><td>${fmt(row.rppSales)}</td>
      <td>${row.contributionRatio.toFixed(1)}%</td><td>${row.rppCv}</td><td>${row.rppCost>0 ? Math.round(row.rppSales/row.rppCost*100) : 0}%</td>`;
    rakutenBody.appendChild(tr);
  });
  const ov = r.rppOverallContribution;
  rakutenFoot.innerHTML = `<tr class="total-row"><td>æœˆæ¬¡åˆè¨ˆ</td><td>${fmt(ov.totalStoreSales)}</td><td>${fmt(ov.totalRppSales)}</td><td>${ov.ratio.toFixed(2)}%</td><td>${ov.totalRppCv}</td><td>${ov.totalRppCvr ? ov.totalRppCvr.toFixed(2) : '-'}%</td></tr>`;

  const rSoldBody = document.getElementById('rSoldBody');
  rSoldBody.innerHTML = '';
  r.soldProductsList.forEach(item => {
    let rankDisplay = item.rank !== '-' ? `<span class="rank-badge">${item.rank}ä½</span>` : '-';
    let rppBadge = item.isRpp ? '<span class="status-badge-on">æ¸ˆ</span>' : '<span class="status-badge-off">æœª</span>';
    let kwBadge = item.isKw ? '<span class="status-badge-on">æ¸ˆ</span>' : '<span class="status-badge-off">æœª</span>';
    rSoldBody.innerHTML += `<tr><td>${item.name.substring(0,20)}...<br><small>${item.id}</small></td><td>${item.count}</td><td>${fmt(item.amount)}</td><td>${rankDisplay}</td><td>${rppBadge}</td><td>${kwBadge}</td></tr>`;
  });

  const rppListBody = document.getElementById('rppListBody');
  rppListBody.innerHTML = '';
  r.activeRppList.forEach(i => { rppListBody.innerHTML += `<tr><td>${i.name.substring(0,20)}...</td><td>${fmt(i.price)}</td><td>${i.cpc}</td></tr>`; });

  const kwListBody = document.getElementById('kwListBody');
  kwListBody.innerHTML = '';
  r.activeKeywordList.forEach(i => { kwListBody.innerHTML += `<tr><td>${i.name.substring(0,10)}...</td><td>${i.keyword}</td><td>${i.cpc}</td></tr>`; });

  const rAddList = document.getElementById('rAddList');
  rAddList.innerHTML = '';
  r.recommendations.add.slice(0,5).forEach(i => {
    const name = i.name || 'å•†å“åä¸æ˜';
    rAddList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-start"><div style="flex:1; margin-right:10px;">${name.substring(0,35)}${name.length > 35 ? '...' : ''}</div><span class="badge bg-success text-nowrap">ROAS:${i.roas}%</span></li>`;
  });
  
  const rMissKwBody = document.getElementById('rMissKwBody');
  rMissKwBody.innerHTML = '';
  r.missingKeywords.slice(0,5).forEach(k => rMissKwBody.innerHTML += `<tr><td>${k.rank}</td><td>${k.keyword}</td><td>${fmt(k.users)}</td></tr>`);

  const rHistBody = document.getElementById('rHistoryBody');
  rHistBody.innerHTML = '';
  r.workHistory.forEach(h => rHistBody.innerHTML += `<tr><td>${h.date}</td><td>${h.type}</td><td>${h.detail}</td></tr>`);

  // --- 3. ãƒãƒ§ã‚¤ã‚¹è©³ç´° ---
  const c = data.choiceData;
  const cm = c.monthlySummaryDetails;
  
  document.getElementById('cSumCost').textContent = fmtC(cm.cost);
  document.getElementById('cSumBudget').textContent = fmtC(c.budgetAnalysis.budget);
  document.getElementById('cSumImp').textContent = fmt(cm.imp);
  document.getElementById('cSumClicks').textContent = fmt(cm.clicks);
  document.getElementById('cSumCpc').textContent = fmt(cm.cpc) + "å††";
  document.getElementById('cSumCtr').textContent = cm.ctr.toFixed(2) + "%";
  document.getElementById('cSumSales').textContent = fmtC(cm.sales);
  document.getElementById('cSumCv').textContent = fmt(cm.cv) + "ä»¶";
  document.getElementById('cSumRoas').textContent = cm.roas.toFixed(0) + "%";
  document.getElementById('cSumCvr').textContent = cm.cvr.toFixed(2) + "%";

  const cProdList = document.getElementById('cProdList');
  cProdList.innerHTML = '';
  c.productList.slice(0,5).forEach(p => {
    cProdList.innerHTML += `<li class="list-group-item d-flex justify-content-between"><div>${p.name.substring(0,12)}...</div><span>${fmt(p.sales)}å††</span></li>`;
  });

  // ãƒãƒ§ã‚¤ã‚¹ CVç²å¾—å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«
  const cSoldBody = document.getElementById('cSoldBody');
  cSoldBody.innerHTML = '';
  const choiceCvProducts = c.productList.filter(p => p.cv > 0);
  choiceCvProducts.forEach(p => {
    const name = p.name || 'å•†å“åä¸æ˜';
    cSoldBody.innerHTML += `<tr>
      <td>${name.substring(0,30)}${name.length > 30 ? '...' : ''}<br><small class="text-muted">ID: ${p.id}</small></td>
      <td><strong>${p.cv}</strong>ä»¶</td>
      <td>${fmt(p.sales)}å††</td>
      <td>${fmt(p.cost)}å††</td>
      <td>${fmt(p.roas)}%</td>
    </tr>`;
  });
  if (choiceCvProducts.length === 0) {
    cSoldBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">CVç²å¾—å•†å“ãªã—</td></tr>';
  }

  const choiceKwBody = document.getElementById('choiceKeywordBody');
  choiceKwBody.innerHTML = '';
  c.keywordList.forEach(k => {
    choiceKwBody.innerHTML += `<tr><td>${k.keyword}</td><td>${k.product.substring(0,15)}...</td><td>${fmt(k.sales)}</td><td>${k.cv}</td><td>${fmt(k.cost)}</td></tr>`;
  });

  const cHistBody = document.getElementById('cHistoryBody');
  cHistBody.innerHTML = '';
  c.workHistory.forEach(h => cHistBody.innerHTML += `<tr><td>${h.date}</td><td>${h.type}</td><td>${h.detail}</td></tr>`);

  // â˜…â˜…â˜… æ¥½å¤© vs ãƒãƒ§ã‚¤ã‚¹ æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ â˜…â˜…â˜…
  renderComparisonSection(r.soldProductsList, choiceCvProducts);

  drawCharts(r.contributionAnalysis, c.chartData);
  generateText(data);
  
  // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¡¨ç¤º
  if (data.historyData && data.historyData.exists && data.meta && data.meta.yearMonth) {
    renderHistoryPanel(data.historyData, data.meta.yearMonth);
  }
}

// â˜…â˜…â˜… å±¥æ­´ä¿å­˜å‡¦ç† â˜…â˜…â˜…
function saveToHistory() {
  const yearMonthInput = document.getElementById('saveYearMonth').value;
  if (!yearMonthInput) {
    alert('å¯¾è±¡å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  const yearMonth = yearMonthInput.replace('-', '/');
  const r = reportData.rakutenData;
  const c = reportData.choiceData;
  const t = reportData.totalData;
  
  const summaryData = {
    rakuten: {
      budget: r.budgetAnalysis.budget,
      cost: r.monthlySummaryDetails.cost,
      sales: r.monthlySummaryDetails.salesTotal,
      cv: r.monthlySummaryDetails.cvTotal,
      roas: r.monthlySummaryDetails.roasTotal,
      cpa: r.monthlySummaryDetails.cvTotal > 0 ? r.monthlySummaryDetails.cost / r.monthlySummaryDetails.cvTotal : 0,
      clicks: r.monthlySummaryDetails.clicks,
      ctr: r.monthlySummaryDetails.ctr,
      cvr: r.monthlySummaryDetails.cvrTotal
    },
    choice: {
      budget: c.budgetAnalysis.budget,
      cost: c.monthlySummaryDetails.cost,
      sales: c.monthlySummaryDetails.sales,
      cv: c.monthlySummaryDetails.cv,
      roas: c.monthlySummaryDetails.roas,
      cpa: c.monthlySummaryDetails.cv > 0 ? c.monthlySummaryDetails.cost / c.monthlySummaryDetails.cv : 0,
      clicks: c.monthlySummaryDetails.clicks,
      imp: c.monthlySummaryDetails.imp,
      ctr: c.monthlySummaryDetails.ctr,
      cvr: c.monthlySummaryDetails.cvr
    },
    total: {
      budget: t.budget,
      cost: t.cost,
      sales: t.sales,
      cv: t.cv,
      roas: t.roas,
      cpa: t.cpa
    }
  };
  
  document.getElementById('saveBtn').disabled = true;
  document.getElementById('saveBtn').textContent = 'ä¿å­˜ä¸­...';
  
  google.script.run
    .withSuccessHandler(result => {
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('saveBtn').innerHTML = '<strong>ğŸ“¥ ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</strong>';
      
      const msgDiv = document.getElementById('saveMessage');
      if (result.success) {
        msgDiv.innerHTML = `<div class="alert alert-success py-1">${result.message}</div>`;
        // å±¥æ­´ã‚’å†å–å¾—ã—ã¦è¡¨ç¤ºæ›´æ–°
        google.script.run.withSuccessHandler(histData => {
          reportData.historyData = histData;
          if (reportData.meta && reportData.meta.yearMonth) {
            renderHistoryPanel(histData, reportData.meta.yearMonth);
          }
        }).getHistoryData();
      } else {
        msgDiv.innerHTML = `<div class="alert alert-danger py-1">${result.message}</div>`;
      }
    })
    .withFailureHandler(err => {
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('saveBtn').innerHTML = '<strong>ğŸ“¥ ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</strong>';
      document.getElementById('saveMessage').innerHTML = `<div class="alert alert-danger py-1">ã‚¨ãƒ©ãƒ¼: ${err}</div>`;
    })
    .saveToHistory(yearMonth, summaryData);
}

// â˜…â˜…â˜… å±¥æ­´ãƒ‘ãƒãƒ«æç”» â˜…â˜…â˜…
function renderHistoryPanel(historyData, currentYearMonth) {
  if (!historyData.records || historyData.records.length === 0) {
    document.getElementById('historyPanel').style.display = 'none';
    document.getElementById('comparisonPanel').style.display = 'none';
    document.getElementById('trendPanel').style.display = 'none';
    return;
  }
  
  const fmt = (n) => new Intl.NumberFormat('ja-JP').format(Math.round(n || 0));
  const records = historyData.records;
  
  // å±¥æ­´ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«
  document.getElementById('historyPanel').style.display = 'block';
  const histBody = document.getElementById('historyBody');
  histBody.innerHTML = '';
  records.forEach(rec => {
    histBody.innerHTML += `<tr>
      <td><strong>${rec.yearMonth}</strong></td>
      <td>${rec.updatedAt}</td>
      <td>${fmt(rec.rakuten.sales)}å††</td>
      <td>${fmt(rec.rakuten.roas)}%</td>
      <td>${fmt(rec.choice.sales)}å††</td>
      <td>${fmt(rec.choice.roas)}%</td>
      <td><strong>${fmt(rec.total.sales)}å††</strong></td>
      <td><strong>${fmt(rec.total.roas)}%</strong></td>
    </tr>`;
  });
  
  // å‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ã®è¨ˆç®—
  if (currentYearMonth && records.length > 0) {
    renderComparisonPanel(records, currentYearMonth);
  }
  
  // 12ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰
  if (records.length >= 2) {
    renderTrendCharts(records);
  }
}

// â˜…â˜…â˜… æ¥½å¤© vs ãƒãƒ§ã‚¤ã‚¹ CVå•†å“æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ â˜…â˜…â˜…
function renderComparisonSection(rakutenProducts, choiceProducts) {
  const fmt = (n) => new Intl.NumberFormat('ja-JP').format(Math.round(n || 0));
  const fmtC = (n) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(Math.round(n || 0));
  
  // æ¥½å¤©å´
  const compareRakutenBody = document.getElementById('compareRakutenBody');
  compareRakutenBody.innerHTML = '';
  const rakutenTop10 = rakutenProducts.slice(0, 10);
  rakutenTop10.forEach((item, idx) => {
    const name = item.name || 'å•†å“åä¸æ˜';
    compareRakutenBody.innerHTML += `<tr>
      <td><span class="badge bg-danger">${idx + 1}</span></td>
      <td>${name.substring(0, 25)}${name.length > 25 ? '...' : ''}</td>
      <td><strong>${item.count || 0}</strong>ä»¶</td>
      <td>${fmt(item.amount || 0)}å††</td>
    </tr>`;
  });
  if (rakutenTop10.length === 0) {
    compareRakutenBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">CVç²å¾—å•†å“ãªã—</td></tr>';
  }
  
  // ãƒãƒ§ã‚¤ã‚¹å´
  const compareChoiceBody = document.getElementById('compareChoiceBody');
  compareChoiceBody.innerHTML = '';
  const choiceTop10 = choiceProducts.slice(0, 10);
  choiceTop10.forEach((item, idx) => {
    const name = item.name || 'å•†å“åä¸æ˜';
    compareChoiceBody.innerHTML += `<tr>
      <td><span class="badge bg-success">${idx + 1}</span></td>
      <td>${name.substring(0, 25)}${name.length > 25 ? '...' : ''}</td>
      <td><strong>${item.cv || 0}</strong>ä»¶</td>
      <td>${fmt(item.sales || 0)}å††</td>
    </tr>`;
  });
  if (choiceTop10.length === 0) {
    compareChoiceBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">CVç²å¾—å•†å“ãªã—</td></tr>';
  }
  
  // ã‚µãƒãƒªãƒ¼
  const rakutenCvCount = rakutenProducts.length;
  const rakutenCvTotal = rakutenProducts.reduce((sum, p) => sum + (p.amount || 0), 0);
  const choiceCvCount = choiceProducts.length;
  const choiceCvTotal = choiceProducts.reduce((sum, p) => sum + (p.sales || 0), 0);
  
  document.getElementById('compareRakutenCount').textContent = rakutenCvCount + 'å•†å“';
  document.getElementById('compareRakutenTotal').textContent = fmtC(rakutenCvTotal);
  document.getElementById('compareChoiceCount').textContent = choiceCvCount + 'å•†å“';
  document.getElementById('compareChoiceTotal').textContent = fmtC(choiceCvTotal);
}

// â˜…â˜…â˜… å‰æœˆæ¯”ãƒ»å‰å¹´æ¯”ãƒ‘ãƒãƒ« â˜…â˜…â˜…
function renderComparisonPanel(records, currentYearMonth) {
  const [year, month] = currentYearMonth.split('/').map(Number);
  
  // å‰æœˆ
  let prevMonth = month - 1;
  let prevMonthYear = year;
  if (prevMonth === 0) { prevMonth = 12; prevMonthYear = year - 1; }
  const prevMonthKey = `${prevMonthYear}/${String(prevMonth).padStart(2, '0')}`;
  
  // å‰å¹´åŒæœˆ
  const prevYearKey = `${year - 1}/${String(month).padStart(2, '0')}`;
  
  // å½“æœˆãƒ‡ãƒ¼ã‚¿ï¼ˆç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿ï¼‰
  const current = {
    rakuten: {
      sales: reportData.rakutenData.monthlySummaryDetails.salesTotal,
      cv: reportData.rakutenData.monthlySummaryDetails.cvTotal,
      roas: reportData.rakutenData.monthlySummaryDetails.roasTotal,
      cost: reportData.rakutenData.monthlySummaryDetails.cost
    },
    choice: {
      sales: reportData.choiceData.monthlySummaryDetails.sales,
      cv: reportData.choiceData.monthlySummaryDetails.cv,
      roas: reportData.choiceData.monthlySummaryDetails.roas,
      cost: reportData.choiceData.monthlySummaryDetails.cost
    },
    total: reportData.totalData
  };
  
  const prevMonthData = records.find(r => r.yearMonth === prevMonthKey);
  const prevYearData = records.find(r => r.yearMonth === prevYearKey);
  
  if (!prevMonthData && !prevYearData) {
    document.getElementById('comparisonPanel').style.display = 'none';
    return;
  }
  
  document.getElementById('comparisonPanel').style.display = 'block';
  
  const fmt = (n) => new Intl.NumberFormat('ja-JP').format(Math.round(n || 0));
  
  const calcDiff = (curr, prev) => {
    if (!prev || prev === 0) return '-';
    const diff = ((curr - prev) / prev) * 100;
    const cls = diff >= 0 ? 'up' : 'down';
    const sign = diff >= 0 ? '+' : '';
    return `<span class="compare-badge ${cls}">${sign}${diff.toFixed(1)}%</span>`;
  };
  
  const metrics = [
    { label: 'å£²ä¸Š/å¯„ä»˜é¡', key: 'sales', suffix: 'å††' },
    { label: 'CVä»¶æ•°', key: 'cv', suffix: 'ä»¶' },
    { label: 'ROAS', key: 'roas', suffix: '%' },
    { label: 'æ¶ˆåŒ–é¡', key: 'cost', suffix: 'å††' }
  ];
  
  let html = '';
  metrics.forEach(m => {
    html += `<tr>
      <td><strong>${m.label}</strong></td>
      <td>${fmt(current.rakuten[m.key])}${m.suffix}</td>
      <td>${prevMonthData ? calcDiff(current.rakuten[m.key], prevMonthData.rakuten[m.key]) : '-'}</td>
      <td>${prevYearData ? calcDiff(current.rakuten[m.key], prevYearData.rakuten[m.key]) : '-'}</td>
      <td>${fmt(current.choice[m.key])}${m.suffix}</td>
      <td>${prevMonthData ? calcDiff(current.choice[m.key], prevMonthData.choice[m.key]) : '-'}</td>
      <td>${prevYearData ? calcDiff(current.choice[m.key], prevYearData.choice[m.key]) : '-'}</td>
      <td><strong>${fmt(current.total[m.key])}${m.suffix}</strong></td>
      <td>${prevMonthData ? calcDiff(current.total[m.key], prevMonthData.total[m.key]) : '-'}</td>
      <td>${prevYearData ? calcDiff(current.total[m.key], prevYearData.total[m.key]) : '-'}</td>
    </tr>`;
  });
  
  document.getElementById('comparisonBody').innerHTML = html;
}

// â˜…â˜…â˜… 12ãƒ¶æœˆãƒˆãƒ¬ãƒ³ãƒ‰ã‚°ãƒ©ãƒ• â˜…â˜…â˜…
function renderTrendCharts(records) {
  document.getElementById('trendPanel').style.display = 'block';
  
  // æœ€æ–°12ãƒ¶æœˆã‚’å–å¾—ï¼ˆå¤ã„é †ã«ã‚½ãƒ¼ãƒˆï¼‰
  const sorted = [...records].sort((a, b) => a.yearMonth.localeCompare(b.yearMonth)).slice(-12);
  
  const labels = sorted.map(r => r.yearMonth);
  const rakutenSales = sorted.map(r => r.rakuten.sales || 0);
  const choiceSales = sorted.map(r => r.choice.sales || 0);
  const totalSales = sorted.map(r => r.total.sales || 0);
  const rakutenRoas = sorted.map(r => r.rakuten.roas || 0);
  const choiceRoas = sorted.map(r => r.choice.roas || 0);
  const totalRoas = sorted.map(r => r.total.roas || 0);
  
  // å£²ä¸Šãƒˆãƒ¬ãƒ³ãƒ‰
  const ctxSales = document.getElementById('trendSalesChart').getContext('2d');
  if (trendSalesChart) trendSalesChart.destroy();
  trendSalesChart = new Chart(ctxSales, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'æ¥½å¤©', data: rakutenSales, backgroundColor: '#BF0000', stack: 'stack' },
        { label: 'ãƒãƒ§ã‚¤ã‚¹', data: choiceSales, backgroundColor: '#00B900', stack: 'stack' },
        { label: 'åˆè¨ˆ', data: totalSales, type: 'line', borderColor: '#2c3e50', borderWidth: 2, fill: false }
      ]
    },
    options: { responsive: true, animation: false, plugins: { title: { display: true, text: 'å£²ä¸Šæ¨ç§» (12ãƒ¶æœˆ)' } } }
  });
  
  // ROASãƒˆãƒ¬ãƒ³ãƒ‰
  const ctxRoas = document.getElementById('trendRoasChart').getContext('2d');
  if (trendRoasChart) trendRoasChart.destroy();
  trendRoasChart = new Chart(ctxRoas, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'æ¥½å¤©', data: rakutenRoas, borderColor: '#BF0000', fill: false },
        { label: 'ãƒãƒ§ã‚¤ã‚¹', data: choiceRoas, borderColor: '#00B900', fill: false },
        { label: 'åˆè¨ˆ', data: totalRoas, borderColor: '#6f42c1', borderWidth: 3, fill: false }
      ]
    },
    options: { responsive: true, animation: false, plugins: { title: { display: true, text: 'ROASæ¨ç§» (12ãƒ¶æœˆ)' } } }
  });
}

function toggleHistoryTable() {
  const wrapper = document.getElementById('historyTableWrapper');
  wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
}

function drawCharts(rData, cData) {
  const ctxR = document.getElementById('rakutenChart').getContext('2d');
  if(rakutenChart) rakutenChart.destroy();
  rakutenChart = new Chart(ctxR, {
    type: 'bar',
    data: {
      labels: rData.map(d=>d.date),
      datasets: [
        { label: 'å£²ä¸Š', data: rData.map(d=>d.rppSales), backgroundColor: '#BF0000', order:1 },
        { label: 'ã‚³ã‚¹ãƒˆ', data: rData.map(d=>d.rppCost), type:'line', borderColor:'#333', order:0 }
      ]
    }, options: { responsive: true, animation: false }
  });

  const ctxRR = document.getElementById('rakutenRoasChart').getContext('2d');
  if(rakutenRoasChart) rakutenRoasChart.destroy();
  rakutenRoasChart = new Chart(ctxRR, {
    type: 'line',
    data: {
      labels: rData.map(d=>d.date),
      datasets: [{ label: 'ROAS', data: rData.map(d=>d.rppCost>0?d.rppSales/d.rppCost*100:0), borderColor: 'orange', fill: true }]
    }, options: { responsive: true, animation: false }
  });

  const ctxC = document.getElementById('choiceChart').getContext('2d');
  if(choiceChart) choiceChart.destroy();
  choiceChart = new Chart(ctxC, {
    type: 'bar',
    data: {
      labels: cData.map(d=>d.date),
      datasets: [
        { label: 'å¯„ä»˜é¡', data: cData.map(d=>d.sales), backgroundColor: '#00B900', order:1 },
        { label: 'æ¶ˆåŒ–é¡', data: cData.map(d=>d.cost), type:'line', borderColor:'#333', order:0 }
      ]
    }, options: { responsive: true, animation: false }
  });
}

function generateText(data) {
  const t = data.totalData;
  const r = data.rakutenData;
  const c = data.choiceData;
  const fmt = (n) => new Intl.NumberFormat('ja-JP').format(Math.round(n));

  let text = `ã€${data.meta.period} åºƒå‘Šé‹ç”¨çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã€‘\n\n`;
  text += `â–  å…¨ä½“ã‚µãƒãƒªãƒ¼\n`;
  text += `å…¨ä½“äºˆç®—${fmt(t.budget)}å††ã«å¯¾ã—ã€å®Ÿç¸¾${fmt(t.cost)}å††ã‚’é‹ç”¨ã€‚\n`;
  text += `åˆè¨ˆ${fmt(t.sales)}å††ã®å¯„ä»˜ï¼ˆ${fmt(t.cv)}ä»¶ï¼‰ã‚’ç²å¾—ã—ã€å…¨ä½“ROASã¯${t.roas.toFixed(0)}%ã§ã—ãŸã€‚\n\n`;

  text += `â–  æ¥½å¤©RPPåºƒå‘Š\n`;
  text += `å£²ä¸Š${fmt(r.monthlySummaryDetails.salesTotal)}å††ã€ROAS${fmt(r.monthlySummaryDetails.roasTotal)}%ã§ç€åœ°ã€‚\n`;
  text += `æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç²å¾—æ•°ã¯${fmt(r.monthlySummaryDetails.cvNew)}ä»¶ã§ã—ãŸã€‚\n`;
  if(r.workHistory.length > 0) {
    text += `ä»Šæœˆã¯ã€Œ${r.workHistory[0].type}ã€ãªã©è¨ˆ${r.workHistory.length}ä»¶ã®èª¿æ•´ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚\n`;
  }
  text += `ç‰¹ã«ã€Œ${r.soldProductsList.length > 0 ? r.soldProductsList[0].name.substring(0,10) : 'å•†å“'}ã€ãŒ${r.soldProductsList.length > 0 ? r.soldProductsList[0].count : 0}ä»¶ç²å¾—ã¨è²¢çŒ®ã—ã¦ã„ã¾ã™ã€‚\n\n`;

  text += `â–  ãµã‚‹ã•ã¨ãƒãƒ§ã‚¤ã‚¹åºƒå‘Š\n`;
  text += `å¯„ä»˜é¡${fmt(c.monthlySummaryDetails.sales)}å††ã€ROAS${fmt(c.monthlySummaryDetails.roas)}%ï¼ˆæ¶ˆåŒ–é¡${fmt(c.monthlySummaryDetails.cost)}å††ï¼‰ã¨ãªã‚Šã¾ã—ãŸã€‚\n`;
  text += `CTRã¯${c.monthlySummaryDetails.ctr.toFixed(2)}%ã€CVRã¯${c.monthlySummaryDetails.cvr.toFixed(2)}%ã§æ¨ç§»ã—ã¾ã—ãŸã€‚\n`;
  if(c.workHistory.length > 0) {
    text += `ãƒãƒ§ã‚¤ã‚¹å´ã§ã¯ã€Œ${c.workHistory[0].type}ã€ç­‰ã®èª¿æ•´ã‚’å®Ÿæ–½æ¸ˆã¿ã§ã™ã€‚\n`;
  }
  
  // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å‰æœˆæ¯”ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
  if (data.historyData && data.historyData.records && data.historyData.records.length > 0) {
    text += `\nâ–  å±¥æ­´ãƒ‡ãƒ¼ã‚¿\n`;
    text += `éå»${data.historyData.records.length}ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚\n`;
  }

  document.getElementById('observationText').value = text;
}

function downloadPDF() {
  const element = document.getElementById('dashboard');
  html2pdf().set({ margin: 0.2, filename: 'Total_Report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } }).from(element).save();
}

function downloadExcel() {
  if (!reportData) return;
  const wb = XLSX.utils.book_new();
  
  const summaryData = [
    ["é …ç›®", "æ¥½å¤©", "ãƒãƒ§ã‚¤ã‚¹", "å…¨ä½“"],
    ["äºˆç®—", reportData.rakutenData.budgetAnalysis.budget, reportData.choiceData.budgetAnalysis.budget, reportData.totalData.budget],
    ["æ¶ˆåŒ–é¡", reportData.rakutenData.monthlySummaryDetails.cost, reportData.choiceData.monthlySummaryDetails.cost, reportData.totalData.cost],
    ["å£²ä¸Š/å¯„ä»˜é¡", reportData.rakutenData.monthlySummaryDetails.salesTotal, reportData.choiceData.monthlySummaryDetails.sales, reportData.totalData.sales],
    ["ROAS(%)", reportData.rakutenData.monthlySummaryDetails.roasTotal, reportData.choiceData.monthlySummaryDetails.roas, reportData.totalData.roas],
    ["CV(ä»¶)", reportData.rakutenData.monthlySummaryDetails.cvTotal, reportData.choiceData.monthlySummaryDetails.cv, reportData.totalData.cv]
  ];
  const wsSum = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, wsSum, "ã‚µãƒãƒªãƒ¼");

  const wsRak = XLSX.utils.json_to_sheet(reportData.rakutenData.contributionAnalysis);
  XLSX.utils.book_append_sheet(wb, wsRak, "æ¥½å¤©æ—¥æ¬¡");

  const wsCho = XLSX.utils.json_to_sheet(reportData.choiceData.chartData);
  XLSX.utils.book_append_sheet(wb, wsCho, "ãƒãƒ§ã‚¤ã‚¹æ—¥æ¬¡");

  const wsRakHist = XLSX.utils.json_to_sheet(reportData.rakutenData.workHistory);
  XLSX.utils.book_append_sheet(wb, wsRakHist, "æ¥½å¤©å±¥æ­´");

  const wsChoHist = XLSX.utils.json_to_sheet(reportData.choiceData.workHistory);
  XLSX.utils.book_append_sheet(wb, wsChoHist, "ãƒãƒ§ã‚¤ã‚¹å±¥æ­´");

  XLSX.writeFile(wb, `Kumano_Report_${reportData.meta.period}.xlsx`);
}
</script>
</body>
</html>
